<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EOEL Hawaii Early Childhood Dashboard</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 1rem;
        }

        .dashboard-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            height: calc(100vh - 120px);
            gap: 1rem;
            padding: 1rem;
        }

        .sidebar {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        .filter-section {
            margin-bottom: 2rem;
        }

        .filter-section h3 {
            color: #4a5568;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 0.5rem;
        }

        .filter-group {
            margin-bottom: 1rem;
        }

        .filter-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #2d3748;
        }

        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .stats-panel {
            background: #f7fafc;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .stat-item:last-child {
            margin-bottom: 0;
        }

        .stat-label {
            color: #4a5568;
            font-size: 0.9rem;
        }

        .stat-value {
            font-weight: bold;
            color: #2d3748;
        }

        .export-section {
            border-top: 1px solid #e2e8f0;
            padding-top: 1rem;
            margin-top: 1rem;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            width: 100%;
            margin-bottom: 0.5rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .map-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }

        #map {
            height: 100%;
            min-height: 500px;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.9);
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
            z-index: 1000;
        }

        .data-table-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: white;
            margin: 2% auto;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            height: 90%;
            overflow: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .close {
            font-size: 1.5rem;
            cursor: pointer;
            color: #a0aec0;
        }

        .close:hover {
            color: #2d3748;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .data-table th,
        .data-table td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
            position: sticky;
            top: 0;
        }

        .data-table tr:hover {
            background: #f7fafc;
        }

        @media (max-width: 768px) {
            .dashboard-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }
            
            .sidebar {
                max-height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🌺 EOEL Hawaii Early Childhood Dashboard</h1>
        <p>Interactive mapping and analysis of Hawaii's early childhood programs</p>
    </div>

    <div class="dashboard-container">
        <div class="sidebar">
            <div class="filter-section">
                <h3>🎯 Filters</h3>
                
                <div class="filter-group">
                    <label for="complexArea">Complex Area:</label>
                    <select id="complexArea">
                        <option value="">All Areas</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="prekStatus">Pre-K Status:</label>
                    <select id="prekStatus">
                        <option value="">All Status</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="militaryImpacted">Military Impacted:</label>
                    <select id="militaryImpacted">
                        <option value="">All</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="titleI">Title I Status:</label>
                    <select id="titleI">
                        <option value="">All</option>
                        <option value="Yes">Title I</option>
                        <option value="No">Non-Title I</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="utilizationFilter">Site Utilization:</label>
                    <select id="utilizationFilter">
                        <option value="">All Levels</option>
                        <option value="low">< 60%</option>
                        <option value="medium">60% - 85%</option>
                        <option value="high">> 85%</option>
                    </select>
                </div>

                <button class="btn" onclick="applyFilters()">Apply Filters</button>
                <button class="btn btn-secondary" onclick="clearFilters()">Clear All</button>
            </div>

            <div class="stats-panel">
                <h3>📊 Current View Stats</h3>
                <div class="stat-item">
                    <span class="stat-label">Total Schools:</span>
                    <span class="stat-value" id="totalSchools">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">EOEL Programs:</span>
                    <span class="stat-value" id="eoelCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Avg Utilization:</span>
                    <span class="stat-value" id="avgUtilization">0%</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Military Impacted:</span>
                    <span class="stat-value" id="militaryCount">0</span>
                </div>
            </div>

            <div class="export-section">
                <h3>🎯 Stakeholder Tools</h3>
                <button class="btn" onclick="showDataTable()">View Data Table</button>
                <button class="btn" onclick="generatePresentationView()">📊 Presentation Mode</button>
                <button class="btn btn-secondary" onclick="showCustomDataBuilder()">🔧 Build Custom Dataset</button>
                <button class="btn btn-secondary" onclick="shareCurrentView()">📤 Share This View</button>
                <button class="btn" onclick="exportToCSV()">📁 Export to CSV</button>
            </div>
        </div>

        <div class="map-container">
            <div class="loading" id="loading">
                <div>🗺️ Loading Hawaii schools...</div>
            </div>
            <div id="map"></div>
        </div>
    </div>

    <!-- Data Table Modal -->
    <div id="dataTableModal" class="data-table-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📊 School Data Table</h2>
                <span class="close" onclick="closeDataTable()">&times;</span>
            </div>
            <div id="tableContainer">
                <table class="data-table" id="dataTable">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="customDataModal" class="data-table-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🔧 Build Custom Dataset for Stakeholders</h2>
                <span class="close" onclick="closeCustomDataBuilder()">&times;</span>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <h3>Select Fields to Include:</h3>
                    <div id="fieldSelector" style="max-height: 400px; overflow-y: auto; border: 1px solid #e2e8f0; padding: 1rem; border-radius: 6px;">
                        <!-- Fields will be populated dynamically -->
                    </div>
                    <div style="margin-top: 1rem;">
                        <button class="btn" onclick="selectAllFields()">Select All</button>
                        <button class="btn btn-secondary" onclick="clearAllFields()">Clear All</button>
                    </div>
                </div>
                <div>
                    <h3>Preview & Export:</h3>
                    <div style="margin-bottom: 1rem;">
                        <label>Dataset Name:</label>
                        <input type="text" id="datasetName" placeholder="e.g. Title I Schools Analysis" style="width: 100%; padding: 0.5rem; margin-top: 0.5rem;">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label>Add Notes:</label>
                        <textarea id="datasetNotes" placeholder="Context for stakeholders..." style="width: 100%; padding: 0.5rem; height: 100px; margin-top: 0.5rem;"></textarea>
                    </div>
                    <div style="background: #f7fafc; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                        <strong>Current Selection:</strong>
                        <div id="selectionSummary">No fields selected</div>
                    </div>
                    <button class="btn" onclick="generateCustomDataset()">📊 Generate Dataset</button>
                    <button class="btn btn-secondary" onclick="previewCustomData()">👁️ Preview Table</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Presentation Mode Modal -->
    <div id="presentationModal" class="data-table-modal">
        <div class="modal-content" style="width: 95%; height: 95%;">
            <div class="modal-header">
                <h2>📊 Stakeholder Presentation View</h2>
                <div>
                    <button class="btn" onclick="printPresentation()" style="margin-right: 1rem;">🖨️ Print</button>
                    <span class="close" onclick="closePresentationMode()">&times;</span>
                </div>
            </div>
            <div id="presentationContent">
                <!-- Presentation content will be generated here -->
            </div>
        </div>
    </div>

    <!-- Share View Modal -->
    <div id="shareModal" class="data-table-modal">
        <div class="modal-content" style="max-width: 600px; height: auto;">
            <div class="modal-header">
                <h2>📤 Share Current View</h2>
                <span class="close" onclick="closeShareModal()">&times;</span>
            </div>
            <div>
                <p style="margin-bottom: 1rem; color: #4a5568;">Share this filtered view with stakeholders:</p>
                <div style="background: #f7fafc; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Shareable URL:</label>
                    <input type="text" id="shareURL" readonly style="width: 100%; padding: 0.5rem; background: white;" onclick="this.select()">
                    <button class="btn" onclick="copyShareURL()" style="margin-top: 0.5rem; width: auto; padding: 0.5rem 1rem;">📋 Copy Link</button>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Email Template:</label>
                    <textarea id="emailTemplate" style="width: 100%; height: 120px; padding: 0.5rem;" readonly></textarea>
                    <button class="btn btn-secondary" onclick="copyEmailTemplate()" style="margin-top: 0.5rem; width: auto; padding: 0.5rem 1rem;">📧 Copy Email</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

    <script>
        // Global variables
        let map;
        let schoolsData = [];
        let filteredData = [];
        let markers = [];

        // Sample data - replace with your CSV data
        const sampleSchools = [
            {
                nameofschool: "Aiea Elementary School",
                zipcode: "96701",
                complexarea: "Pearl City-Aiea",
                prekstatusofnoneoelschools: "Has Pre-K",
                militaryimpacted: "Yes",
                titlei2425: "Yes",
                siteutilization: "78%",
                currentenrollmentsy2324: 450,
                sitecapacity: 575,
                eoelfundedfciloncampus: "Yes",
                lat: 21.3845,
                lng: -157.9284
            },
            {
                nameofschool: "Kailua Elementary School",
                zipcode: "96734",
                complexarea: "Kailua-Kalaheo",
                prekstatusofnoneoelschools: "No Pre-K",
                militaryimpacted: "No",
                titlei2425: "No",
                siteutilization: "92%",
                currentenrollmentsy2324: 385,
                sitecapacity: 420,
                eoelfundedfciloncampus: "No",
                lat: 21.4022,
                lng: -157.7394
            },
            {
                nameofschool: "Waianae Elementary School",
                zipcode: "96792",
                complexarea: "Waianae",
                prekstatusofnoneoelschools: "Has Pre-K",
                militaryimpacted: "No",
                titlei2425: "Yes",
                siteutilization: "65%",
                currentenrollmentsy2324: 520,
                sitecapacity: 800,
                eoelfundedfciloncampus: "Yes",
                lat: 21.4389,
                lng: -158.1867
            },
            {
                nameofschool: "Mililani Elementary School",
                zipcode: "96789",
                complexarea: "Mililani-Waipio-Melemanu",
                prekstatusofnoneoelschools: "Has Pre-K",
                militaryimpacted: "Yes",
                titlei2425: "No",
                siteutilization: "88%",
                currentenrollmentsy2324: 642,
                sitecapacity: 730,
                eoelfundedfciloncampus: "Yes",
                lat: 21.4511,
                lng: -158.0156
            },
            {
                nameofschool: "Hilo Elementary School",
                zipcode: "96720",
                complexarea: "Hilo-Waiakea",
                prekstatusofnoneoelschools: "Has Pre-K",
                militaryimpacted: "No",
                titlei2425: "Yes",
                siteutilization: "71%",
                currentenrollmentsy2324: 355,
                sitecapacity: 500,
                eoelfundedfciloncampus: "No",
                lat: 19.7297,
                lng: -155.0890
            }
        ];

        // Initialize the dashboard
        function initDashboard() {
            // Load sample data (replace with CSV loading logic)
            schoolsData = sampleSchools;
            filteredData = [...schoolsData];
            
            // Initialize map
            initMap();
            
            // Populate filter dropdowns
            populateFilters();
            
            // Display initial data
            displayMarkers();
            updateStats();
            
            // Hide loading
            document.getElementById('loading').style.display = 'none';
        }

        // Initialize Leaflet map centered on Hawaii
        function initMap() {
            map = L.map('map').setView([21.3099, -157.8581], 8);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
        }

        // Populate filter dropdowns with unique values
        function populateFilters() {
            const complexAreas = [...new Set(schoolsData.map(school => school.complexarea))].sort();
            const prekStatuses = [...new Set(schoolsData.map(school => school.prekstatusofnoneoelschools))].sort();
            
            populateSelect('complexArea', complexAreas);
            populateSelect('prekStatus', prekStatuses);
        }

        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
        }

        // Display school markers on map
        function displayMarkers() {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // Add new markers
            filteredData.forEach(school => {
                const marker = L.marker([school.lat, school.lng])
                    .bindPopup(createPopupContent(school))
                    .addTo(map);
                
                markers.push(marker);
            });
        }

        // Create popup content for school markers
        function createPopupContent(school) {
            const utilization = parseFloat(school.siteutilization) || 0;
            const utilizationColor = utilization > 85 ? '#48bb78' : utilization > 60 ? '#ed8936' : '#e53e3e';
            
            return `
                <div style="min-width: 200px;">
                    <h4 style="margin-bottom: 0.5rem; color: #2d3748;">${school.nameofschool}</h4>
                    <div style="margin-bottom: 0.3rem;"><strong>Complex Area:</strong> ${school.complexarea}</div>
                    <div style="margin-bottom: 0.3rem;"><strong>ZIP Code:</strong> ${school.zipcode}</div>
                    <div style="margin-bottom: 0.3rem;"><strong>Pre-K Status:</strong> ${school.prekstatusofnoneoelschools}</div>
                    <div style="margin-bottom: 0.3rem;"><strong>EOEL Program:</strong> ${school.eoelfundedfciloncampus}</div>
                    <div style="margin-bottom: 0.3rem;"><strong>Military Impacted:</strong> ${school.militaryimpacted}</div>
                    <div style="margin-bottom: 0.3rem;"><strong>Title I:</strong> ${school.titlei2425}</div>
                    <div style="margin-bottom: 0.3rem;">
                        <strong>Utilization:</strong> 
                        <span style="color: ${utilizationColor}; font-weight: bold;">${school.siteutilization}</span>
                    </div>
                    <div><strong>Enrollment:</strong> ${school.currentenrollmentsy2324} / ${school.sitecapacity}</div>
                </div>
            `;
        }

        // Apply filters
        function applyFilters() {
            const complexArea = document.getElementById('complexArea').value;
            const prekStatus = document.getElementById('prekStatus').value;
            const militaryImpacted = document.getElementById('militaryImpacted').value;
            const titleI = document.getElementById('titleI').value;
            const utilizationFilter = document.getElementById('utilizationFilter').value;
            
            filteredData = schoolsData.filter(school => {
                // Complex area filter
                if (complexArea && school.complexarea !== complexArea) return false;
                
                // Pre-K status filter
                if (prekStatus && school.prekstatusofnoneoelschools !== prekStatus) return false;
                
                // Military impacted filter
                if (militaryImpacted && school.militaryimpacted !== militaryImpacted) return false;
                
                // Title I filter
                if (titleI && school.titlei2425 !== titleI) return false;
                
                // Utilization filter
                if (utilizationFilter) {
                    const utilization = parseFloat(school.siteutilization) || 0;
                    if (utilizationFilter === 'low' && utilization >= 60) return false;
                    if (utilizationFilter === 'medium' && (utilization < 60 || utilization > 85)) return false;
                    if (utilizationFilter === 'high' && utilization <= 85) return false;
                }
                
                return true;
            });
            
            displayMarkers();
            updateStats();
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('complexArea').value = '';
            document.getElementById('prekStatus').value = '';
            document.getElementById('militaryImpacted').value = '';
            document.getElementById('titleI').value = '';
            document.getElementById('utilizationFilter').value = '';
            
            filteredData = [...schoolsData];
            displayMarkers();
            updateStats();
        }

        // Update statistics panel
        function updateStats() {
            const totalSchools = filteredData.length;
            const eoelCount = filteredData.filter(school => school.eoelfundedfciloncampus === 'Yes').length;
            const militaryCount = filteredData.filter(school => school.militaryimpacted === 'Yes').length;
            
            const avgUtilization = filteredData.length > 0 ? 
                filteredData.reduce((sum, school) => sum + (parseFloat(school.siteutilization) || 0), 0) / filteredData.length : 0;
            
            document.getElementById('totalSchools').textContent = totalSchools;
            document.getElementById('eoelCount').textContent = eoelCount;
            document.getElementById('avgUtilization').textContent = avgUtilization.toFixed(1) + '%';
            document.getElementById('militaryCount').textContent = militaryCount;
        }

        // Show data table modal
        function showDataTable() {
            const modal = document.getElementById('dataTableModal');
            const tableHead = document.getElementById('tableHead');
            const tableBody = document.getElementById('tableBody');
            
            // Clear existing content
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';
            
            if (filteredData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="100%">No data matches current filters</td></tr>';
                modal.style.display = 'block';
                return;
            }
            
            // Create header row
            const headers = ['School Name', 'Complex Area', 'ZIP', 'Pre-K Status', 'EOEL Program', 'Military', 'Title I', 'Utilization', 'Enrollment'];
            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            tableHead.appendChild(headerRow);
            
            // Create data rows
            filteredData.forEach(school => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${school.nameofschool}</td>
                    <td>${school.complexarea}</td>
                    <td>${school.zipcode}</td>
                    <td>${school.prekstatusofnoneoelschools}</td>
                    <td>${school.eoelfundedfciloncampus}</td>
                    <td>${school.militaryimpacted}</td>
                    <td>${school.titlei2425}</td>
                    <td>${school.siteutilization}</td>
                    <td>${school.currentenrollmentsy2324} / ${school.sitecapacity}</td>
                `;
                tableBody.appendChild(row);
            });
            
            modal.style.display = 'block';
        }

        // Close data table modal
        function closeDataTable() {
            document.getElementById('dataTableModal').style.display = 'none';
        }

        // Export filtered data to CSV
        function exportToCSV() {
            if (filteredData.length === 0) {
                alert('No data to export. Please adjust your filters.');
                return;
            }
            
            const headers = Object.keys(filteredData[0]);
            const csvContent = [
                headers.join(','),
                ...filteredData.map(row => headers.map(header => `"${row[header] || ''}"`).join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `eoel_schools_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Generate presentation view for stakeholders
        function generatePresentationView() {
            const modal = document.getElementById('presentationModal');
            const content = document.getElementById('presentationContent');
            
            // Get current filter state for context
            const activeFilters = [];
            const complexArea = document.getElementById('complexArea').value;
            const prekStatus = document.getElementById('prekStatus').value;
            const militaryImpacted = document.getElementById('militaryImpacted').value;
            const titleI = document.getElementById('titleI').value;
            const utilizationFilter = document.getElementById('utilizationFilter').value;
            
            if (complexArea) activeFilters.push(`Complex Area: ${complexArea}`);
            if (prekStatus) activeFilters.push(`Pre-K Status: ${prekStatus}`);
            if (militaryImpacted) activeFilters.push(`Military Impacted: ${militaryImpacted}`);
            if (titleI) activeFilters.push(`Title I: ${titleI}`);
            if (utilizationFilter) activeFilters.push(`Utilization: ${utilizationFilter}`);
            
            // Calculate key metrics
            const totalSchools = filteredData.length;
            const eoelCount = filteredData.filter(school => school.eoelfundedfciloncampus === 'Yes').length;
            const militaryCount = filteredData.filter(school => school.militaryimpacted === 'Yes').length;
            const titleICount = filteredData.filter(school => school.titlei2425 === 'Yes').length;
            const avgUtilization = filteredData.length > 0 ? 
                filteredData.reduce((sum, school) => sum + (parseFloat(school.siteutilization) || 0), 0) / filteredData.length : 0;
            
            // Group by complex area for breakdown
            const areaBreakdown = {};
            filteredData.forEach(school => {
                if (!areaBreakdown[school.complexarea]) {
                    areaBreakdown[school.complexarea] = { count: 0, eoel: 0, military: 0, titleI: 0, totalUtilization: 0 };
                }
                areaBreakdown[school.complexarea].count++;
                if (school.eoelfundedfciloncampus === 'Yes') areaBreakdown[school.complexarea].eoel++;
                if (school.militaryimpacted === 'Yes') areaBreakdown[school.complexarea].military++;
                if (school.titlei2425 === 'Yes') areaBreakdown[school.complexarea].titleI++;
                areaBreakdown[school.complexarea].totalUtilization += parseFloat(school.siteutilization) || 0;
            });
            
            content.innerHTML = `
                <div style="padding: 2rem; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                    <div style="text-align: center; margin-bottom: 2rem; border-bottom: 2px solid #667eea; padding-bottom: 1rem;">
                        <h1 style="color: #2d3748; margin-bottom: 0.5rem;">Hawaii Early Childhood Education Overview</h1>
                        <p style="color: #4a5568; font-size: 1.1rem;">EOEL Dashboard Analysis • Generated ${new Date().toLocaleDateString()}</p>
                        ${activeFilters.length > 0 ? `<p style="color: #667eea; font-style: italic;">Filtered by: ${activeFilters.join(', ')}</p>` : ''}
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                        <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 1.5rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 0.5rem;">${totalSchools}</div>
                            <div style="font-size: 1rem; opacity: 0.9;">Total Schools</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #48bb78, #38a169); color: white; padding: 1.5rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 0.5rem;">${eoelCount}</div>
                            <div style="font-size: 1rem; opacity: 0.9;">EOEL Programs</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #ed8936, #dd6b20); color: white; padding: 1.5rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 0.5rem;">${avgUtilization.toFixed(0)}%</div>
                            <div style="font-size: 1rem; opacity: 0.9;">Avg Utilization</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #9f7aea, #805ad5); color: white; padding: 1.5rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 0.5rem;">${militaryCount}</div>
                            <div style="font-size: 1rem; opacity: 0.9;">Military Impacted</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 2rem;">
                        <h2 style="color: #2d3748; margin-bottom: 1rem; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.5rem;">Complex Area Breakdown</h2>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                <thead style="background: #f7fafc;">
                                    <tr>
                                        <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #e2e8f0;">Complex Area</th>
                                        <th style="padding: 1rem; text-align: center; border-bottom: 1px solid #e2e8f0;">Schools</th>
                                        <th style="padding: 1rem; text-align: center; border-bottom: 1px solid #e2e8f0;">EOEL Programs</th>
                                        <th style="padding: 1rem; text-align: center; border-bottom: 1px solid #e2e8f0;">Military Impacted</th>
                                        <th style="padding: 1rem; text-align: center; border-bottom: 1px solid #e2e8f0;">Title I</th>
                                        <th style="padding: 1rem; text-align: center; border-bottom: 1px solid #e2e8f0;">Avg Utilization</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Object.entries(areaBreakdown).map(([area, data]) => `
                                        <tr style="border-bottom: 1px solid #f1f5f9;">
                                            <td style="padding: 1rem; font-weight: 500;">${area}</td>
                                            <td style="padding: 1rem; text-align: center;">${data.count}</td>
                                            <td style="padding: 1rem; text-align: center;">${data.eoel}</td>
                                            <td style="padding: 1rem; text-align: center;">${data.military}</td>
                                            <td style="padding: 1rem; text-align: center;">${data.titleI}</td>
                                            <td style="padding: 1rem; text-align: center;">${(data.totalUtilization / data.count).toFixed(1)}%</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 2rem;">
                        <h2 style="color: #2d3748; margin-bottom: 1rem; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.5rem;">Key Insights</h2>
                        <div style="background: #f7fafc; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #667eea;">
                            <ul style="margin: 0; padding-left: 1.5rem; line-height: 1.6;">
                                <li style="margin-bottom: 0.5rem;"><strong>${((eoelCount/totalSchools)*100).toFixed(1)}%</strong> of schools have EOEL programs</li>
                                <li style="margin-bottom: 0.5rem;"><strong>${((titleICount/totalSchools)*100).toFixed(1)}%</strong> are Title I schools</li>
                                <li style="margin-bottom: 0.5rem;"><strong>${((militaryCount/totalSchools)*100).toFixed(1)}%</strong> are military-impacted</li>
                                <li style="margin-bottom: 0.5rem;">Average site utilization: <strong>${avgUtilization.toFixed(1)}%</strong></li>
                                <li><strong>${Object.keys(areaBreakdown).length}</strong> complex areas represented</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e2e8f0; color: #4a5568; font-size: 0.9rem;">
                        <p>Generated by EOEL Dashboard • Hawaii Early Childhood Education Analysis</p>
                        <p>For questions contact: EOEL Data Team</p>
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        // Show custom data builder
        function showCustomDataBuilder() {
            const modal = document.getElementById('customDataModal');
            const fieldSelector = document.getElementById('fieldSelector');
            
            // Define all available fields with user-friendly names
            const fieldMappings = {
                'nameofschool': 'School Name',
                'complexarea': 'Complex Area',
                'zipcode': 'ZIP Code',
                'prekstatusofnoneoelschools': 'Pre-K Status',
                'militaryimpacted': 'Military Impacted',
                'titlei2425': 'Title I Status',
                'siteutilization': 'Site Utilization',
                'currentenrollmentsy2324': 'Current Enrollment',
                'sitecapacity': 'Site Capacity',
                'eoelfundedfciloncampus': 'EOEL Program On Campus',
                'eoelcapacity': 'EOEL Capacity',
                'principalemail': 'Principal Email',
                'grades': 'Grade Levels'
            };
            
            fieldSelector.innerHTML = '';
            Object.entries(fieldMappings).forEach(([field, label]) => {
                const div = document.createElement('div');
                div.style.marginBottom = '0.5rem';
                div.innerHTML = `
                    <label style="display: flex; align-items: center; cursor: pointer; padding: 0.5rem; border-radius: 4px; transition: background 0.2s;"
                           onmouseover="this.style.background='#f7fafc'" onmouseout="this.style.background='transparent'">
                        <input type="checkbox" value="${field}" style="margin-right: 0.5rem;">
                        <span>${label}</span>
                    </label>
                `;
                fieldSelector.appendChild(div);
            });
            
            modal.style.display = 'block';
        }

        // Share current view
        function shareCurrentView() {
            const modal = document.getElementById('shareModal');
            const shareURL = document.getElementById('shareURL');
            const emailTemplate = document.getElementById('emailTemplate');
            
            // Create URL with current filter parameters
            const params = new URLSearchParams();
            const complexArea = document.getElementById('complexArea').value;
            const prekStatus = document.getElementById('prekStatus').value;
            const militaryImpacted = document.getElementById('militaryImpacted').value;
            const titleI = document.getElementById('titleI').value;
            const utilizationFilter = document.getElementById('utilizationFilter').value;
            
            if (complexArea) params.append('complexArea', complexArea);
            if (prekStatus) params.append('prekStatus', prekStatus);
            if (militaryImpacted) params.append('militaryImpacted', militaryImpacted);
            if (titleI) params.append('titleI', titleI);
            if (utilizationFilter) params.append('utilizationFilter', utilizationFilter);
            
            const baseURL = window.location.origin + window.location.pathname;
            const fullURL = params.toString() ? `${baseURL}?${params.toString()}` : baseURL;
            shareURL.value = fullURL;
            
            // Create email template
            const filterSummary = [];
            if (complexArea) filterSummary.push(`Complex Area: ${complexArea}`);
            if (prekStatus) filterSummary.push(`Pre-K Status: ${prekStatus}`);
            if (militaryImpacted) filterSummary.push(`Military Impacted: ${militaryImpacted}`);
            if (titleI) filterSummary.push(`Title I: ${titleI}`);
            if (utilizationFilter) filterSummary.push(`Utilization: ${utilizationFilter}`);
            
            const totalSchools = filteredData.length;
            const eoelCount = filteredData.filter(school => school.eoelfundedfciloncampus === 'Yes').length;
            
            emailTemplate.value = `Subject: Hawaii Early Childhood Education Data - Dashboard View

Hi [Stakeholder Name],

I've prepared a customized view of our Hawaii early childhood education data for your review:

${filterSummary.length > 0 ? `Applied Filters: ${filterSummary.join(', ')}` : 'Showing all schools in dataset'}

Key Summary:
• Total Schools: ${totalSchools}
• EOEL Programs: ${eoelCount}
• Military Impacted: ${filteredData.filter(school => school.militaryimpacted === 'Yes').length}

View the interactive dashboard here: ${fullURL}

The dashboard allows you to:
- View all schools on an interactive Hawaii map
- Filter by various criteria
- Export data for further analysis
- Generate presentation-ready summaries

Please let me know if you need any additional analysis or have questions about the data.

Best regards,
EOEL Team`;
            
            modal.style.display = 'block';
        }

        // Generate custom dataset
        function generateCustomDataset() {
            const checkboxes = document.querySelectorAll('#fieldSelector input[type="checkbox"]:checked');
            const selectedFields = Array.from(checkboxes).map(cb => cb.value);
            const datasetName = document.getElementById('datasetName').value || 'Custom_Dataset';
            const datasetNotes = document.getElementById('datasetNotes').value;
            
            if (selectedFields.length === 0) {
                alert('Please select at least one field to include in your dataset.');
                return;
            }
            
            // Create CSV content with selected fields
            const headers = selectedFields;
            const csvContent = [
                `# ${datasetName}`,
                `# Generated: ${new Date().toLocaleString()}`,
                `# Records: ${filteredData.length}`,
                datasetNotes ? `# Notes: ${datasetNotes}` : '',
                '', // Empty line
                headers.join(','),
                ...filteredData.map(row => headers.map(header => `"${row[header] || ''}"`).join(','))
            ].filter(line => line !== '').join('\n');
            
            // Download the file
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${datasetName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            closeCustomDataBuilder();
        }

        // Helper functions for modals
        function selectAllFields() {
            const checkboxes = document.querySelectorAll('#fieldSelector input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
            updateSelectionSummary();
        }

        function clearAllFields() {
            const checkboxes = document.querySelectorAll('#fieldSelector input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            updateSelectionSummary();
        }

        function updateSelectionSummary() {
            const checkboxes = document.querySelectorAll('#fieldSelector input[type="checkbox"]:checked');
            const summary = document.getElementById('selectionSummary');
            summary.textContent = checkboxes.length > 0 ? 
                `${checkboxes.length} fields selected (${filteredData.length} records)` : 
                'No fields selected';
        }

        function copyShareURL() {
            const shareURL = document.getElementById('shareURL');
            shareURL.select();
            document.execCommand('copy');
            alert('URL copied to clipboard!');
        }

        function copyEmailTemplate() {
            const emailTemplate = document.getElementById('emailTemplate');
            emailTemplate.select();
            document.execCommand('copy');
            alert('Email template copied to clipboard!');
        }

        function printPresentation() {
            window.print();
        }

        function closeCustomDataBuilder() {
            document.getElementById('customDataModal').style.display = 'none';
        }

        function closePresentationMode() {
            document.getElementById('presentationModal').style.display = 'none';
        }

        function closeShareModal() {
            document.getElementById('shareModal').style.display = 'none';
        }

        // Load URL parameters on page load
        function loadURLParameters() {
            const params = new URLSearchParams(window.location.search);
            
            if (params.get('complexArea')) document.getElementById('complexArea').value = params.get('complexArea');
            if (params.get('prekStatus')) document.getElementById('prekStatus').value = params.get('prekStatus');
            if (params.get('militaryImpacted')) document.getElementById('militaryImpacted').value = params.get('militaryImpacted');
            if (params.get('titleI')) document.getElementById('titleI').value = params.get('titleI');
            if (params.get('utilizationFilter')) document.getElementById('utilizationFilter').value = params.get('utilizationFilter');
            
            // Apply filters if any were loaded from URL
            if (params.toString()) {
                applyFilters();
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('dataTableModal');
            if (event.target === modal) {
                closeDataTable();
            }
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initDashboard();
            loadURLParameters(); // Load any shared view parameters
        });
    </script>
</body>
</html>
