<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EOEL Hawaii Early Childhood Dashboard</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 1rem;
        }

        .dashboard-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            height: calc(100vh - 120px);
            gap: 1rem;
            padding: 1rem;
        }

        .sidebar {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        .filter-section {
            margin-bottom: 2rem;
        }

        .filter-section h3 {
            color: #4a5568;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 0.5rem;
        }

        .filter-group {
            margin-bottom: 1rem;
        }

        .filter-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #2d3748;
        }

        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .stats-panel {
            background: #f7fafc;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .stat-item:last-child {
            margin-bottom: 0;
        }

        .stat-label {
            color: #4a5568;
            font-size: 0.9rem;
        }

        .stat-value {
            font-weight: bold;
            color: #2d3748;
        }

        .export-section {
            border-top: 1px solid #e2e8f0;
            padding-top: 1rem;
            margin-top: 1rem;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            width: 100%;
            margin-bottom: 0.5rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .map-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }

        #map {
            height: 100%;
            min-height: 500px;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.9);
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
            z-index: 1000;
        }

        .data-table-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: white;
            margin: 2% auto;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            height: 90%;
            overflow: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .close {
            font-size: 1.5rem;
            cursor: pointer;
            color: #a0aec0;
        }

        .close:hover {
            color: #2d3748;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .data-table th,
        .data-table td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
            position: sticky;
            top: 0;
        }

        .data-table tr:hover {
            background: #f7fafc;
        }

        @media (max-width: 768px) {
            .dashboard-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }
            
            .sidebar {
                max-height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üå∫ EOEL Hawaii Early Childhood Dashboard</h1>
        <p>Executive analysis of Hawaii's early learning programs and capacity</p>
    </div>

    <div class="dashboard-container">
        <div class="sidebar">
            <div class="filter-section">
                <h3>üéØ Filters</h3>
                
                <div class="filter-group">
                    <label for="complexArea">Complex Area:</label>
                    <select id="complexArea">
                        <option value="">All Areas</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="complex">Complex:</label>
                    <select id="complex">
                        <option value="">All Complexes</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="gradeLevel">Grade Level:</label>
                    <select id="gradeLevel">
                        <option value="">All Levels</option>
                        <option value="elementary">Elementary (K-6)</option>
                        <option value="intermediate">Intermediate (6-8)</option>
                        <option value="high">High School (9-12)</option>
                        <option value="combined">Combined (K-12)</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="eoelStatus">EOEL Program Status:</label>
                    <select id="eoelStatus">
                        <option value="">All Schools</option>
                        <option value="has_eoel">Has EOEL Program</option>
                        <option value="no_eoel">No EOEL Program</option>
                        <option value="planned">Planned/Opening</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="titleI">Title I Status:</label>
                    <select id="titleI">
                        <option value="">All</option>
                        <option value="Yes">Title I</option>
                        <option value="No">Non-Title I</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="utilizationFilter">Site Utilization:</label>
                    <select id="utilizationFilter">
                        <option value="">All Levels</option>
                        <option value="under">Under-utilized (< 70%)</option>
                        <option value="optimal">Optimal (70% - 95%)</option>
                        <option value="over">Over-capacity (> 95%)</option>
                    </select>
                </div>

                <button class="btn" onclick="applyFilters()">Apply Filters</button>
                <button class="btn btn-secondary" onclick="clearFilters()">Clear All</button>
            </div>

            <div class="stats-panel">
                <h3>üìä Current View Stats</h3>
                <div class="stat-item">
                    <span class="stat-label">Total Schools:</span>
                    <span class="stat-value" id="totalSchools">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">EOEL Programs:</span>
                    <span class="stat-value" id="eoelCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">EOEL Capacity:</span>
                    <span class="stat-value" id="eoelCapacity">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Avg Utilization:</span>
                    <span class="stat-value" id="avgUtilization">0%</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Title I Schools:</span>
                    <span class="stat-value" id="titleICount">0</span>
                </div>
            </div>

            <div class="export-section">
                <h3>üéØ Executive Tools</h3>
                <button class="btn" onclick="loadLiveData()" id="loadDataBtn">üîÑ Load Live EOEL Data</button>
                <button class="btn" onclick="showDataTable()">View Data Table</button>
                <button class="btn" onclick="generateExecutiveSummary()">üìä Executive Summary</button>
                <button class="btn btn-secondary" onclick="showCustomReportBuilder()">üîß Build Custom Report</button>
                <button class="btn btn-secondary" onclick="shareCurrentView()">üì§ Share This View</button>
                <button class="btn" onclick="exportToCSV()">üìÅ Export to CSV</button>
            </div>

            <div class="stats-panel" style="margin-top: 1rem;">
                <h3>üìç Data Source</h3>
                <div id="dataSourceInfo" style="font-size: 0.9rem; color: #4a5568; line-height: 1.4;">
                    Using sample data (6 schools). Click "Load Live EOEL Data" above to connect to your Google Sheet.
                </div>
            </div>
        </div>

        <div class="map-container">
            <div class="loading" id="loading">
                <div>üó∫Ô∏è Loading EOEL schools from Google Sheets...</div>
            </div>
            <div id="map"></div>
        </div>
    </div>

    <!-- Data Table Modal -->
    <div id="dataTableModal" class="data-table-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìä EOEL School Data Table</h2>
                <span class="close" onclick="closeDataTable()">&times;</span>
            </div>
            <div id="tableContainer">
                <table class="data-table" id="dataTable">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Executive Summary Modal -->
    <div id="executiveModal" class="data-table-modal">
        <div class="modal-content" style="width: 95%; height: 95%;">
            <div class="modal-header">
                <h2>üìä EOEL Executive Summary</h2>
                <div>
                    <button class="btn" onclick="printExecutiveSummary()" style="margin-right: 1rem;">üñ®Ô∏è Print</button>
                    <span class="close" onclick="closeExecutiveSummary()">&times;</span>
                </div>
            </div>
            <div id="executiveContent"></div>
        </div>
    </div>

    <!-- Custom Report Builder Modal -->
    <div id="customReportModal" class="data-table-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üîß Build Custom Report for Executive Team</h2>
                <span class="close" onclick="closeCustomReportBuilder()">&times;</span>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <h3>Select Fields to Include:</h3>
                    <div id="fieldSelector" style="max-height: 400px; overflow-y: auto; border: 1px solid #e2e8f0; padding: 1rem; border-radius: 6px;">
                        <!-- Fields will be populated dynamically -->
                    </div>
                    <div style="margin-top: 1rem;">
                        <button class="btn" onclick="selectAllFields()">Select All</button>
                        <button class="btn btn-secondary" onclick="clearAllFields()">Clear All</button>
                    </div>
                </div>
                <div>
                    <h3>Preview & Export:</h3>
                    <div style="margin-bottom: 1rem;">
                        <label>Report Name:</label>
                        <input type="text" id="reportName" placeholder="e.g. Complex Area EOEL Analysis" style="width: 100%; padding: 0.5rem; margin-top: 0.5rem;">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label>Add Notes:</label>
                        <textarea id="reportNotes" placeholder="Context for executive team..." style="width: 100%; padding: 0.5rem; height: 100px; margin-top: 0.5rem;"></textarea>
                    </div>
                    <div style="background: #f7fafc; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                        <strong>Current Selection:</strong>
                        <div id="selectionSummary">No fields selected</div>
                    </div>
                    <button class="btn" onclick="generateCustomReport()">üìä Generate Report</button>
                    <button class="btn btn-secondary" onclick="previewCustomData()">üëÅÔ∏è Preview Table</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Share View Modal -->
    <div id="shareModal" class="data-table-modal">
        <div class="modal-content" style="max-width: 600px; height: auto;">
            <div class="modal-header">
                <h2>üì§ Share Current View</h2>
                <span class="close" onclick="closeShareModal()">&times;</span>
            </div>
            <div>
                <p style="margin-bottom: 1rem; color: #4a5568;">Share this filtered view with colleagues:</p>
                <div style="background: #f7fafc; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Shareable URL:</label>
                    <input type="text" id="shareURL" readonly style="width: 100%; padding: 0.5rem; background: white;" onclick="this.select()">
                    <button class="btn" onclick="copyShareURL()" style="margin-top: 0.5rem; width: auto; padding: 0.5rem 1rem;">üìã Copy Link</button>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Email Template:</label>
                    <textarea id="emailTemplate" style="width: 100%; height: 120px; padding: 0.5rem;" readonly></textarea>
                    <button class="btn btn-secondary" onclick="copyEmailTemplate()" style="margin-top: 0.5rem; width: auto; padding: 0.5rem 1rem;">üìß Copy Email</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

    <script>
        // Global variables
        let map;
        let schoolsData = [];
        let filteredData = [];
        let markers = [];

        // Google Sheets configuration
        const SHEET_ID = '1l8UAyei-dawrCo0RX6zhyOTm2283R0gB9MVXFjbRy_Y';
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`;

        // Initialize the dashboard
        async function initDashboard() {
            try {
                loadSampleData();
                initMap();
                populateFilters();
                geocodeSchools();
                displayMarkers();
                updateStats();
                document.getElementById('loading').style.display = 'none';
                
                console.log('Dashboard loaded with sample data. Click "Load Live EOEL Data" to connect to Google Sheets.');
            } catch (error) {
                console.error('Error initializing dashboard:', error);
                document.getElementById('loading').innerHTML = '<div style="color: red;">Dashboard loaded with sample data. Google Sheets integration available.</div>';
            }
        }

        // Load sample data
        function loadSampleData() {
            schoolsData = [
                {
                    'Name of School': 'Wailuku Elementary School',
                    'School Code': '425',
                    'Complex Area': 'Baldwin-Kekaulike-K≈´lanihƒÅko ªi-Maui',
                    'Complex': 'Baldwin',
                    'Grades': 'K-5',
                    'EOEL PreK': '2023 2024',
                    'EOEL Capacity': '40',
                    '# EOEL Rooms': '2',
                    'Title I (24-25)': 'YES',
                    'Site Capacity': '789',
                    'Site Utilization': '67.81%',
                    'Current Enrollment (SY 24-25)': '535',
                    'English LanguageLearners': '18.00%',
                    'Zip Code': '96793',
                    'Principal': 'Dr. Nikan Arapoff',
                    'Principal Email': 'Nikan.Arapoff@k12.hi.us'
                },
                {
                    'Name of School': 'Kahului Elementary School',
                    'School Code': '405',
                    'Complex Area': 'Baldwin-Kekaulike-K≈´lanihƒÅko ªi-Maui',
                    'Complex': 'Maui',
                    'Grades': 'K-5',
                    'EOEL PreK': '',
                    'EOEL Capacity': '',
                    '# EOEL Rooms': '0',
                    'Title I (24-25)': 'NO',
                    'Site Capacity': '825',
                    'Site Utilization': '94.30%',
                    'Current Enrollment (SY 24-25)': '778',
                    'English LanguageLearners': '18.00%',
                    'Zip Code': '96732',
                    'Principal': 'Suzanne Forbes',
                    'Principal Email': 'Suzanne.Forbes@k12.hi.us'
                },
                {
                    'Name of School': 'Barbers Point Elementary School',
                    'School Code': '251',
                    'Complex Area': 'Campbell-Kapolei',
                    'Complex': 'Kapolei',
                    'Grades': 'K-5',
                    'EOEL PreK': '2025 (1)',
                    'EOEL Capacity': '20',
                    '# EOEL Rooms': '1',
                    'Title I (24-25)': 'NO',
                    'Site Capacity': '584',
                    'Site Utilization': '88.01%',
                    'Current Enrollment (SY 24-25)': '514',
                    'English LanguageLearners': '27.00%',
                    'Zip Code': '96707',
                    'Principal': 'Aaron Okumura',
                    'Principal Email': 'aaron.okumura@k12.hi.us'
                },
                {
                    'Name of School': 'Hau ªula Elementary School',
                    'School Code': '303',
                    'Complex Area': 'Castle-Kahuku',
                    'Complex': 'Kahuku',
                    'Grades': 'K-6',
                    'EOEL PreK': '2025 (2)',
                    'EOEL Capacity': '40',
                    '# EOEL Rooms': '2',
                    'Title I (24-25)': 'NO',
                    'Site Capacity': '330',
                    'Site Utilization': '113.64%',
                    'Current Enrollment (SY 24-25)': '375',
                    'English LanguageLearners': '16.00%',
                    'Zip Code': '96717',
                    'Principal': 'Uilani Kaitoku',
                    'Principal Email': 'Uilani.Kaitoku@k12.hi.us'
                },
                {
                    'Name of School': 'Hilo High School',
                    'School Code': '355',
                    'Complex Area': 'Hilo-WaiƒÅkea',
                    'Complex': 'Hilo',
                    'Grades': '9-12',
                    'EOEL PreK': '',
                    'EOEL Capacity': '',
                    '# EOEL Rooms': '0',
                    'Title I (24-25)': 'NO',
                    'Site Capacity': '1070',
                    'Site Utilization': '109.35%',
                    'Current Enrollment (SY 24-25)': '1170',
                    'English LanguageLearners': '25.00%',
                    'Zip Code': '96720',
                    'Principal': 'Jasmine Urasaki',
                    'Principal Email': 'Jasmine.Urasaki@k12.hi.us'
                },
                {
                    'Name of School': 'LƒÅna\'i High & Elementary School',
                    'School Code': '415',
                    'Complex Area': 'HƒÅna-Lahainaluna-LƒÅna ªi-Molokai',
                    'Complex': 'LƒÅna ªi',
                    'Grades': 'K-12',
                    'EOEL PreK': '2014 - E 2024 - H',
                    'EOEL Capacity': '37',
                    '# EOEL Rooms': '2',
                    'Title I (24-25)': 'NO',
                    'Site Capacity': '624',
                    'Site Utilization': '91.67%',
                    'Current Enrollment (SY 24-25)': '572',
                    'English LanguageLearners': '17.00%',
                    'Zip Code': '96763',
                    'Principal': 'Douglas Boyer',
                    'Principal Email': 'Douglas.Boyer@k12.hi.us'
                }
            ];
            filteredData = [...schoolsData];
        }

        // Improved CSV parser that handles quotes and commas properly
        function parseCSV(csvText) {
            console.log('üîç Starting CSV parse...');
            console.log('üîç Raw CSV length:', csvText.length);
            
            // Function to parse a single CSV line handling quotes
            function parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const nextChar = line[i + 1];
                    
                    if (char === '"') {
                        if (inQuotes && nextChar === '"') {
                            // Escaped quote
                            current += '"';
                            i++; // Skip next quote
                        } else {
                            // Toggle quote mode
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        // End of field
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                // Don't forget last field
                result.push(current.trim());
                return result;
            }
            
            const lines = csvText.split(/\r?\n/); // Handle both \n and \r\n
            console.log('üîç Total lines:', lines.length);
            
            // Find header row - look for "Name of School"
            let headerRowIndex = -1;
            for (let i = 0; i < Math.min(10, lines.length); i++) {
                if (lines[i].toLowerCase().includes('name of school')) {
                    headerRowIndex = i;
                    break;
                }
            }
            
            if (headerRowIndex === -1) {
                console.error('‚ùå Could not find header row');
                return [];
            }
            
            console.log('‚úÖ Found headers at row:', headerRowIndex + 1);
            
            // Parse headers properly
            const headers = parseCSVLine(lines[headerRowIndex]);
            console.log('üìã Total fields found:', headers.length);
            console.log('üìã All headers:', headers);
            
            // Show which fields we found
            const importantFields = [
                'Name of School', 'School Code', 'Complex Area', 'Complex', 
                'Grades', 'EOEL PreK', 'EOEL Capacity', '# EOEL Rooms',
                'Title I (24-25)', 'Site Capacity', 'Site Utilization',
                'Current Enrollment (SY 24-25)', 'English LanguageLearners',
                'Zip Code', 'ZIP Code', 'Principal', 'Principal Email'
            ];
            
            console.log('üîç Checking for important fields:');
            importantFields.forEach(field => {
                const found = headers.some(h => h.toLowerCase() === field.toLowerCase());
                console.log(`  ${found ? '‚úÖ' : '‚ùå'} ${field}`);
            });
            
            const data = [];
            let skippedRows = 0;
            
            // Parse data rows
            for (let i = headerRowIndex + 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const values = parseCSVLine(line);
                
                // Check if we have the right number of fields
                if (values.length !== headers.length) {
                    console.warn(`‚ö†Ô∏è Row ${i + 1} has ${values.length} fields, expected ${headers.length}`);
                    skippedRows++;
                    continue;
                }
                
                const row = {};
                for (let j = 0; j < headers.length; j++) {
                    row[headers[j]] = values[j] || '';
                }
                
                // Only include if has school name
                const schoolName = row['Name of School'] || '';
                if (schoolName && schoolName !== 'Name of School') {
                    data.push(row);
                }
            }
            
            console.log('üè´ Successfully parsed:', data.length, 'schools (expecting 258)');
            if (skippedRows > 0) {
                console.log('‚ö†Ô∏è Skipped rows with field count mismatch:', skippedRows);
            }
            
            // Log sample of first school to verify all fields
            if (data.length > 0) {
                console.log('üìä First school complete data:');
                Object.entries(data[0]).forEach(([key, value]) => {
                    console.log(`  ${key}: ${value}`);
                });
            }
            
            return data;
        }

        // Load live data from Google Sheets
        async function loadLiveData() {
            const loadBtn = document.getElementById('loadDataBtn');
            const dataSourceInfo = document.getElementById('dataSourceInfo');
            
            loadBtn.textContent = '‚è≥ Loading...';
            loadBtn.disabled = true;
            dataSourceInfo.textContent = 'Connecting to Google Sheets...';
            
            try {
                // Use the public CSV export URL
                const csvUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`;
                
                console.log('üì° Fetching from:', csvUrl);
                
                // Try direct fetch first
                const response = await fetch(csvUrl, {
                    mode: 'cors',
                    credentials: 'omit'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const csvText = await response.text();
                console.log('‚úÖ Fetched CSV, size:', csvText.length, 'characters');
                
                // Parse the CSV
                schoolsData = parseCSV(csvText);
                
                if (schoolsData.length === 0) {
                    throw new Error('No valid data rows found in CSV');
                }
                
                filteredData = [...schoolsData];
                
                console.log(`‚úÖ Loaded ${schoolsData.length} schools (expecting 258)`);
                
                // Update UI
                populateFilters();
                await geocodeSchools();
                displayMarkers();
                updateStats();
                
                loadBtn.textContent = `‚úÖ Loaded ${schoolsData.length} Schools`;
                loadBtn.style.background = 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)';
                dataSourceInfo.innerHTML = `
                    <strong>‚úÖ Live Google Sheets Data</strong><br>
                    Loaded ${schoolsData.length} of 258 schools<br>
                    <small>Last updated: ${new Date().toLocaleString()}</small>
                `;
                
            } catch (error) {
                console.error('‚ùå Error loading data:', error);
                
                // Show manual import option
                loadBtn.textContent = '‚ùå Try Manual Import';
                loadBtn.disabled = false;
                loadBtn.onclick = showManualImportDialog;
                
                dataSourceInfo.innerHTML = `
                    <strong>‚ö†Ô∏è Auto-load failed</strong><br>
                    Click button above for manual import<br>
                    <small>Error: ${error.message}</small>
                `;
            }
        }

        // Add manual import dialog as fallback
        function showManualImportDialog() {
            const modal = document.createElement('div');
            modal.className = 'data-table-modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h2>üìä Manual CSV Import</h2>
                        <span class="close" onclick="this.closest('.data-table-modal').remove()">&times;</span>
                    </div>
                    <div style="padding: 1rem;">
                        <p><strong>To import your data manually:</strong></p>
                        <ol>
                            <li>Open your Google Sheet</li>
                            <li>File ‚Üí Download ‚Üí Comma Separated Values (.csv)</li>
                            <li>Open the CSV file in a text editor</li>
                            <li>Copy ALL the text (Ctrl+A, then Ctrl+C)</li>
                            <li>Paste it below:</li>
                        </ol>
                        <textarea id="csvImport" style="width: 100%; height: 300px; margin: 1rem 0; font-family: monospace;"></textarea>
                        <button class="btn" onclick="processManualImport()">Import CSV Data</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function processManualImport() {
            const csvText = document.getElementById('csvImport').value;
            if (!csvText.trim()) {
                alert('Please paste CSV data first');
                return;
            }
            
            try {
                schoolsData = parseCSV(csvText);
                filteredData = [...schoolsData];
                
                if (schoolsData.length === 0) {
                    throw new Error('No valid schools found in CSV');
                }
                
                // Update everything
                populateFilters();
                geocodeSchools();
                displayMarkers();
                updateStats();
                
                // Update UI
                document.getElementById('loadDataBtn').textContent = `‚úÖ ${schoolsData.length} Schools Imported`;
                document.getElementById('dataSourceInfo').innerHTML = `
                    <strong>‚úÖ Manual Import Success</strong><br>
                    Loaded ${schoolsData.length} schools<br>
                    <small>Imported: ${new Date().toLocaleString()}</small>
                `;
                
                // Close modal
                document.querySelector('.data-table-modal').remove();
                
                alert(`Successfully imported ${schoolsData.length} schools!`);
                
            } catch (error) {
                alert(`Import error: ${error.message}`);
                console.error('Import error:', error);
            }
        }
